/*! jQuery Media Outlet plugin - v1.0 - 2014-07-11
 * https://github.com/jcoudsi/jquery.media.outlet
 * Copyright (c) 2014 Julien Coudsi; Licensed MIT */

 (function(e){function t(t,n){n=e.extend({uploadDir:null,uploadedFileTypes:"png, gif, jpg",maxFileSize:10485760,defaultMode:"upload",preview:true,onSuccess:null,onError:null},n);a(t,n);var r=t.find(".media_outlet_upload_progress_bar");var i=t.find(".media_outlet_upload_progress_info");r.hide();i.hide();t.children("[class$='_mode']").slideUp();t.children(".media_outlet_"+n.defaultMode+"_mode").slideDown();t.children(".media_outlet_"+n.defaultMode+"_option").prop("checked",true);if(n.preview===true){t.find(".media_outlet_media_preview").show()}else{t.find(".media_outlet_media_preview").hide()}t.find("input[type=radio]").change(function(t){e(this).siblings("[class$='_mode']").hide();e(this).siblings(".media_outlet_"+e(this).attr("value")+"_mode").fadeIn()});return n}function n(e,t,n){var o=null;if(e.name.length!==0){o=s(e.name)}if(t.serverFileName){if(t.serverFileName.indexOf("data-")===0){var u=n.parents("div["+t.serverFileName+"]").attr(t.serverFileName);if(r(u)){return i(u,e)}else{return u+"."+o}}else{if(r(t.serverFileName)){return i(t.serverFileName,e)}else{return t.serverFileName+"."+o}}}else{return e.name}}function r(e){return e.indexOf("!")===0&&e.indexOf("!",e.length-1)!==-1}function i(e,t){var n=e.replace("{fileName}",t.name);return n.substring(1,n.length-1)}function s(e){if(e.indexOf("http")===0&&e.indexOf("youtube")!==-1){return"youtube"}else{var t=e.split("/");var n=t[t.length-1];var r=n.split(".");if(r.length>1){return r[r.length-1].toLowerCase()}else{return null}}return null}function o(e,t){var n=e.siblings(".media_outlet_input_url").val();var r=new RegExp("^(http[s]?:\\/\\/(www\\.)?|ftp:\\/\\/(www\\.)?|www\\.){1}([0-9A-Za-z-\\.@:%_+~#=]+)+((\\.[a-zA-Z]{2,3})+)(/(.)*)?(\\?(.)*)?");if(!r.test(n)){alert("URL non valide");return}var i=s(n);f(e.parent().siblings(".media_outlet_media_preview"),i,n,t.noPreviewImage);if(t.onSuccess){var o={mediaType:i,mediaUrl:n,mediaSelectionType:"url"};var u=e.parent().siblings(".media_outlet_media_preview").parent("div");t.onSuccess(o,u)}}function u(t,r,i){if(r.urlService){var o=i.target.files[0];if(o){var u=n(o,r,t);var a=s(u);var l=o.size;if(l>r.maxFileSize){alert("Le fichier fait plus de 10 megaoctets");return}if(r.uploadedFileTypes.indexOf(a)===-1){alert("Le type de fichier ("+a+") n'est pas autorisé");return}var c=t.siblings(".media_outlet_upload_progress_bar");var h=t.siblings(".media_outlet_upload_progress_info");c.fadeIn();h.fadeIn();var p=t.parent().siblings(".media_outlet_media_preview").parent("div");e.ajax({type:"POST",url:r.urlService,headers:{"Content-Type":"application/octet-stream","Uploaded-File-Location":r.uploadDir,"Uploaded-File-Name":u},data:o,processData:false,dataType:"text",success:function(e){h.text("Upload terminé");var n=e+"/"+u;f(t.parent().siblings(".media_outlet_media_preview"),a,n,r.noPreviewImage);if(r.onSuccess){var i={mediaName:u,mediaType:a,mediaUrl:n,mediaSelectionType:"upload"};r.onSuccess(i,p)}},error:function(e,t,n){h.text("Erreur durant l'upload");if(r.onError){r.onError(n,p)}},xhr:function(){var t=e.ajaxSettings.xhr();t.upload.onprogress=function(e){c.attr("value",e.loaded/e.total*100);h.text("Upload en cours : "+parseInt(e.loaded/e.total*100)+"%")};return t}})}}else{console.debug("ERROR : You must specify the URL of the script to call for file upload")}}function a(e,t){e.append('<div class="media_outlet_media_preview"><div class="media_outlet_image_preview"><img src=""></div><div class="media_outlet_youtube_preview"><iframe width="300" height="200" src="" frameborder="0" allowfullscreen></iframe></div><div class="media_outlet_no_preview"><img src=""></div></div>');if(t.loadedMedia){var n=t.loadedMedia;var r=e.attr(n);var i=s(e.attr(n))}else{var r=null;var i=null}var o=e.children(".media_outlet_media_preview");f(o,i,r,t.noPreviewImage);e.append('<input type="radio" class="media_outlet_upload_option" name="sourceType" value="upload" />Télécharger depuis l \'ordinateur');e.append('<input type="radio" class="media_outlet_url_option" name="sourceType" value="url" />Saisir une URL');e.append('<div class="media_outlet_upload_mode"><input type="file" value="Choisir un fichier" class="media_outlet_button_upload" /><progress class="media_outlet_upload_progress_bar" value="0" max="100"></progress><p class="media_outlet_upload_progress_info"></p></div>');e.append('<div class="media_outlet_url_mode">Saisir une URL : <input type="text" class="media_outlet_input_url" value="http://" /><input type="button" class="media_outlet_button_validate_url_media" value="Valider" /></div>')}function f(e,t,n,r){e.find("div").hide();if(n){if(t==="jpg"||t==="png"||t==="gif"){e.find(".media_outlet_image_preview img").attr("src",n);e.find(".media_outlet_image_preview").show()}else if(t==="youtube"){var i=n.split("=");var s=i[i.length-1];e.find("iframe").attr("src","//www.youtube.com/embed/"+s);e.find(".media_outlet_youtube_preview").show()}else{if(r){var o=null;if(r.indexOf("data-")===0){o=e.parent("div["+r+"]").attr(r)}else{o=r}e.find(".media_outlet_no_preview img").attr("src",o)}e.find(".media_outlet_no_preview").show()}}}e.fn.mediaOutlet=function(n){return this.each(function(){n=t(e(this),n);e(this).find(".media_outlet_button_upload").change(function(t){u(e(this),n,t)});e(this).find(".media_outlet_button_validate_url_media").click(function(t){o(e(this),n)})})}})(jQuery)