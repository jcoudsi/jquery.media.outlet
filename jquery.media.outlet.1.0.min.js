/*! jQuery Media Outlet plugin - v1.0 - 2014-07-11
 * https://github.com/jcoudsi/jquery.media.outlet
 * Copyright (c) 2014 Julien Coudsi; Licensed MIT */

!function(e){function i(i,t){t=e.extend({uploadDir:null,uploadedFileTypes:"png, gif, jpg, pdf",maxFileSize:10485760,defaultMode:"upload",preview:!0,onSuccess:null,onError:null},t),o(i,t);var a=i.find(".media_outlet_upload_progress_bar"),r=i.find(".media_outlet_upload_progress_info");return a.hide(),r.hide(),i.children("[class$='_mode']").slideUp(),i.children(".media_outlet_"+t.defaultMode+"_mode").slideDown(),i.children(".media_outlet_"+t.defaultMode+"_option").prop("checked",!0),t.preview===!0?i.find(".media_outlet_media_preview").show():i.find(".media_outlet_media_preview").hide(),i.find("input[type=radio]").change(function(){e(this).siblings("[class$='_mode']").hide(),e(this).siblings(".media_outlet_"+e(this).attr("value")+"_mode").fadeIn()}),t}function t(e,i,t){var d=null;if(0!==e.name.length&&(d=l(e.name)),i.serverFileName){if(0===i.serverFileName.indexOf("data-")){var n=t.parents("div["+i.serverFileName+"]").attr(i.serverFileName);return a(n)?r(n,e):n+"."+d}return a(i.serverFileName)?r(i.serverFileName,e):i.serverFileName+"."+d}return e.name}function a(e){return 0===e.indexOf("!")&&-1!==e.indexOf("!",e.length-1)}function r(e,i){var t=e.replace("{fileName}",i.name);return t.substring(1,t.length-1)}function l(e){if(0===e.indexOf("http")&&-1!==e.indexOf("youtube"))return"youtube";var i=e.split("/"),t=i[i.length-1],a=t.split(".");return a.length>1?a[a.length-1].toLowerCase():null}function d(e,i){var t=e.siblings(".media_outlet_input_url").val(),a=new RegExp("^(http[s]?:\\/\\/(www\\.)?|ftp:\\/\\/(www\\.)?|www\\.){1}([0-9A-Za-z-\\.@:%_+~#=]+)+((\\.[a-zA-Z]{2,3})+)(/(.)*)?(\\?(.)*)?");if(!a.test(t))return void alert("URL non valide");var r=l(t);if(u(e.parent().siblings(".media_outlet_media_preview"),r,t,i.noPreviewImage),i.onSuccess){var d={mediaType:r,mediaUrl:t,mediaSelectionType:"url"},n=e.parent().siblings(".media_outlet_media_preview").parent("div");i.onSuccess(d,n)}}function n(i,a,r){if(a.urlService){var d=r.target.files[0];if(d){var n=t(d,a,i),o=l(n),s=d.size;if(s>a.maxFileSize)return void alert("Le fichier fait plus de 10 megaoctets");if(-1===a.uploadedFileTypes.indexOf(o))return void alert("Le type de fichier ("+o+") n'est pas autorisé");var p=i.siblings(".media_outlet_upload_progress_bar"),_=i.siblings(".media_outlet_upload_progress_info");p.fadeIn(),_.fadeIn();var m=i.parent().siblings(".media_outlet_media_preview").parent("div");e.ajax({type:"POST",url:a.urlService,headers:{"Content-Type":"application/octet-stream","Uploaded-File-Location":a.uploadDir,"Uploaded-File-Name":n},data:d,processData:!1,dataType:"text",success:function(e){_.text("Upload terminé");var t=e+"/"+n;if(u(i.parent().siblings(".media_outlet_media_preview"),o,t,a.noPreviewImage),a.onSuccess){var r={mediaName:n,mediaType:o,mediaUrl:t,mediaSelectionType:"upload"};a.onSuccess(r,m)}},error:function(e,i,t){_.text("Erreur durant l'upload"),a.onError&&a.onError(t,m)},xhr:function(){var i=e.ajaxSettings.xhr();return i.upload.onprogress=function(e){p.attr("value",e.loaded/e.total*100),_.text("Upload en cours : "+parseInt(e.loaded/e.total*100)+"%")},i}})}}else console.debug("ERROR : You must specify the URL of the script to call for file upload")}function o(e,i){if(e.append('<div class="media_outlet_media_preview"><div class="media_outlet_image_preview"><img src=""></div><div class="media_outlet_youtube_preview"><iframe width="300" height="200" src="" frameborder="0" allowfullscreen></iframe></div><div class="media_outlet_no_preview"></div></div>'),i.loadedMedia)var t=i.loadedMedia,a=e.attr(t),r=l(e.attr(t));else var a=null,r=null;var d=e.children(".media_outlet_media_preview");u(d,r,a,i.noPreviewImage),e.append('<input type="radio" class="media_outlet_upload_option" name="sourceType" value="upload" />Télécharger depuis l \'ordinateur'),e.append('<input type="radio" class="media_outlet_url_option" name="sourceType" value="url" />Saisir une URL'),e.append('<div class="media_outlet_upload_mode"><input type="file" value="Choisir un fichier" class="media_outlet_button_upload" /><progress class="media_outlet_upload_progress_bar" value="0" max="100"></progress><p class="media_outlet_upload_progress_info"></p></div>'),e.append('<div class="media_outlet_url_mode">Saisir une URL : <input type="text" class="media_outlet_input_url" value="http://" /><input type="button" class="media_outlet_button_validate_url_media" value="Valider" /></div>')}function u(e,i,t,a){if(e.find("div").hide(),t)if("jpg"===i||"png"===i||"gif"===i)e.find(".media_outlet_image_preview img").attr("src",t),e.find(".media_outlet_image_preview").show();else if("youtube"===i){var r=t.split("="),l=r[r.length-1];e.find("iframe").attr("src","//www.youtube.com/embed/"+l),e.find(".media_outlet_youtube_preview").show()}else{if(a){var d=null;d=0===a.indexOf("data-")?e.parent("div["+a+"]").attr(a):a,e.find(".media_outlet_no_preview img").attr("src",d)}e.find(".media_outlet_no_preview").show()}}e.fn.mediaOutlet=function(t){return this.each(function(){t=i(e(this),t),e(this).find(".media_outlet_button_upload").change(function(i){n(e(this),t,i)}),e(this).find(".media_outlet_button_validate_url_media").click(function(){d(e(this),t)})})}}(jQuery);